/**
 * Order service using MongoDB transactions
 */

const Order = require("../models/order.model");
const Product = require("../models/product.model");
const runTransaction = require("../utils/transaction");

async function placeOrderTransactional(userId, items) {
    return await runTransaction(async (session) => {
        let total = 0;

        for (const item of items) {
            const product = await Product.findById(item.productId).session(session);
            if (!product || product.stock < item.quantity) {
                throw new Error("Stock issue with product");
            }

            product.stock -= item.quantity;
            await product.save({ session });

            total += product.price * item.quantity;
        }

        const order = new Order({
            userId,
            items,
            totalAmount: total
        });

        return await order.save({ session });
    });
}

module.exports = { placeOrderTransactional };
